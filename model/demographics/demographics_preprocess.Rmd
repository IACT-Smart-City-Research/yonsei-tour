---
title: "demographic_preprocess"
author: "Lee"
date: '2019 11 14 '
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(data.table)
df <- data.table::fread('./2018 외래관광객 실태조사 원자료.csv', encoding = 'UTF-8')
```

참고 : 1628번째 설문조사 만족한 활동지 998이라는 오타 발견 지움

현재 분석 계획은 인구통계 정보만 가지고

> Q5_1 : 방문 주요 목적(1번이 아니면 여행자가 아니므로 삭제하자.)
>
> Q5_2A1: 목적 1위
>
> Q5_2A2: 목적 2위
>
> Q5_2A3: 목적 3위
>
> Q9-1A1~Q9_1A20 : 참여한 활동을 모두 선택인데 tidy한 꼴로 전처리 필요
> > 스포츠 레포츠 산업시설 연수 등 관광이 아닌건 다 빼버림
>
> Q9_2A1 :만족 활동 1위
>
> Q9_2A2 :만족 활동 2위
>
> Q9_2A3 :만족 활동 3위 
>
> Q10_1A1 ~ Q10_1A1 : 방문 지역 (지도 시각화를 할 때 써먹을 수 있을 듯, 혹은 서울만 여행조사를 한다면 서울 비방문자는 빼버리기)
> > ~~비 서울에 대한 관광지 정보가 부족하므로 제거(예를 들어 만족 관광지에 제주 하나로 퉁침)~~
>
> Q11A1 : 만족 관광지 1위
>
> Q11A2 : 만족 관광지 2위
>
> Q11A3 : 만족 관광지 3위
>
> Q15_1 : 전반적 만족도
>
> Q15_2A8 : 관광지(문화유산, 자연경관, 야간관광) 매력도
>
> Q18_A1 : 여행전 한국의 이미지
>
> Q18_A2 : 여행후 한국의 이미지
>
> D_MON : 방문 월
>
> D_COU : 국적
>
> D_GEN : 성별
>
> D_AGE : 나이



```{r}
df <- df %>% 
    select(Q5_1, starts_with('Q5_2'), starts_with('Q9_1A'), starts_with('Q9_2A'), starts_with('Q10_1A'),
           starts_with('Q11A'), starts_with('Q15_1'), starts_with('Q15_2A8'), starts_with('Q18A'),
           D_MON, D_COU, D_GEN, D_AGE) %>%
    filter(Q5_1 == '여가, 위락, 휴식') %>%
    select(-Q5_1)
```

Q9_1A 부분 tidy한 꼴로 만들기

```{r}
df <- df %>% 
    mutate(pasted = paste(Q9_1A1, Q9_1A2, Q9_1A3)) %>%
    mutate('참여_식도락' = grepl('식도락', pasted),
           '참여_쇼핑' = grepl('쇼핑', pasted),
           '참여_자연경관관' = grepl('자연경관', pasted),
           '참여_유적지' = grepl('유적지', pasted),
           '참여_유흥' = grepl('유흥', pasted),
           '참여_박물관' = grepl('박물관', pasted),
           '참여_놀이공원' = grepl('놀이공원', pasted),
           '참여_휴양' = grepl('휴양', pasted),
           '참여_축제' = grepl('축제', pasted),
           '참여_전통체험' = grepl('전통체험', pasted),
           '참여_촬영지' = grepl('촬영지', pasted),
           '참여_시티투어버스' = grepl('시티투어', pasted),
           '참여_박람회' = grepl('박람회', pasted),
           '참여_뷰티관광' = grepl('뷰티관광', pasted),
           '참여_의료관광' = grepl('의료관광', pasted)) %>%
    select(-pasted, -starts_with('Q9_1A'))
```

Q10_1A tidy 하게

```{r}
preprocess_list <- colnames(df)[grepl('Q10_1A', colnames(df))]
for(cname in preprocess_list){
    location_name = unique(df[cname])[unique(df[cname])!='']
    df[cname] <- ifelse(df[cname]!="", TRUE, FALSE)
    colnames(df)[match(TRUE, colnames(df)==cname)] = paste0('방문_',location_name)
}
```

Q15_1 이상한 글자

```{r}
df$Q15_1[grepl('매우 만족', df$Q15_1)] = '매우만족'
df$Q15_1[grepl('대체로 만족', df$Q15_1)] = '대체로만족'
df$Q15_1[grepl('보통', df$Q15_1)] = '보통'
df$Q15_1[grepl('대체로 불만족', df$Q15_1)] = '대체로불만족'
df$Q15_1[grepl('매우 불만족', df$Q15_1)] = '매우불만족'
```

Q15_2A8 이상한 글자

```{r}
df$Q15_2A8[grepl('매우 만족', df$Q15_2A8)] = '매우만족'
df$Q15_2A8[grepl('대체로 만족', df$Q15_2A8)] = '대체로만족'
df$Q15_2A8[grepl('보통', df$Q15_2A8)] = '보통'
df$Q15_2A8[grepl('대체로 불만족', df$Q15_2A8)] = '대체로불만족'
df$Q15_2A8[grepl('매우 불만족', df$Q15_2A8)] = '매우불만족'
df$Q15_2A8[grepl('해당 없음', df$Q15_2A8)] = NA
```

Q18A1 Q18A2 이상한글자

```{r}
df$Q18A1[grepl('매우 좋았다', df$Q18A1)] = '매우만족'
df$Q18A1[grepl('좋았다', df$Q18A1)] = '대체로만족'
df$Q18A1[grepl('보통', df$Q18A1)] = '보통'
df$Q18A1[grepl('매우 나빴다', df$Q18A1)] = '매우불만족'
df$Q18A1[grepl('나빴다', df$Q18A1)] = '대체로불만족'

df$Q18A2[grepl('매우 좋았다', df$Q18A2)] = '매우만족'
df$Q18A2[grepl('좋았다', df$Q18A2)] = '대체로만족'
df$Q18A2[grepl('보통', df$Q18A2)] = '보통'
df$Q18A2[grepl('매우 나빴다', df$Q18A2)] = '매우불만족'
df$Q18A2[grepl('나빴다', df$Q18A2)] = '대체로불만족'
```

```{r}
df <- rename(df, 목적_1위=Q5_2A1, 목적_2위=Q5_2A2, 목적_3위=Q5_2A3,
             활동_1위=Q9_2A1, 활동_2위=Q9_2A2, 활동_3위=Q9_2A3,
             방문지_1위=Q11A1, 방문지_2위=Q11A2, 방문지_3위=Q11A3,
             만족도=Q15_1, 관광지매력도 = Q15_2A8, 여행전이미지=Q18A1, 여행후이미지=Q18A2,
             방문월=D_MON, 국적=D_COU, 성별=D_GEN, 나이=D_AGE)
```

```{r}
df['방문월'] <- gsub('\\s+', '', df[['방문월']])
#01월, 02월, ..
temp <- df[lapply(as.character(df[['방문월']]), nchar)==2, '방문월']
temp <- paste0('0',temp)
df[lapply(as.character(df[['방문월']]), nchar)==2, '방문월'] <- temp

df['국적'] <- gsub('\\s+', '', df[['국적']])
df['성별'] <- gsub('\\s+', '', df[['성별']])
df['나이'] <- gsub('\\s+', '', df[['나이']])
```

~~서울 비방문자 제거, 서울 이외의 방문 관심 없음~~

전국으로 확대하기로 함

```{r}
# df <- df %>% filter(방문_서울==TRUE)
# df <- df %>% 
#   mutate(imsi=방문_서울) %>%
#   select(-starts_with('방문_')) %>%
#   rename(방문_서울=imsi)
```


결측치
```{r}
df[df==''] = NA
```

> 뜬금없지만, 깨달은 것은 만족도 2위 방문지 만족도 3위 방문지도 살리는 게 좋을 것 같은데
>
> 내 생각엔, 가장 살리기 좋은 방법은 샘플을 여러개 만드는 것이다.
> 
> 만약 3위까지 적었으면 샘플이 3개로 늘어난다.

```{r}
is_2nd <- !(df %>% pull('방문지_2위') %>% is.na)
is_3rd <- !(df %>% pull('방문지_3위') %>% is.na)
df_2nd <- df[is_2nd,]
df_2nd['방문지_1위'] <- df_2nd[['방문지_2위']]
df_3rd <- df[is_3rd,]
df_3rd['방문지_1위'] <- df_3rd[['방문지_3위']]
df <- rbind(df, df_2nd, df_3rd)
df <- df %>% select(-방문지_2위, -방문지_3위) %>% rename(만족방문지=방문지_1위)
```

character as factor
```{r}
character_columns <- names(sapply(df, class)[sapply(df, class) == 'character'])
df[character_columns] <- lapply(df[character_columns] , factor)
```

ordered factor
```{r}
df['만족도'] <- ordered(df[['만족도']], levels = c("매우불만족", "대체로불만족",
                                   "보통", '대체로만족', '매우만족'))
df['관광지매력도'] <- ordered(df[['관광지매력도']], 
                        levels = c("매우불만족", "대체로불만족",
                                   "보통", '대체로만족', '매우만족'))
df['여행전이미지'] <- ordered(df[['여행전이미지']], 
                        levels = c("매우불만족", "대체로불만족",
                                   "보통", '대체로만족', '매우만족'))
df['여행후이미지'] <- ordered(df[['여행후이미지']], 
                        levels = c("매우불만족", "대체로불만족",
                                   "보통", '대체로만족', '매우만족'))
```


matrix as logical
```{r}
matrix_columns <- names(sapply(df, class)[sapply(df, class) == 'matrix'])
df[matrix_columns] <- lapply(df[matrix_columns] , as.logical)
```

# 1 방문지 issue

$$
\begin{align} X &= \text{인구통계, 방문월, 고려요인} \\
Y &= \text{만족방문지, 만족도} \end{align}
$$

> **만족 방문지와 만족도는 같이 살리긴 어렵고 만족도는 만족도는 마이너하지만 숨겨진 명소를 찾아낼 때 사용하자**

문제는 여기의 방문지와 우리가 조사한 방문지가 조금 다르다.

왜냐면 여기는 조금 추상적으로 지역을 매핑했다. 예를 들어서 강서구, 목동, 왕십리 ... 이런 식으로 지역을 표현하였다.

**방문지를 클러스터**로 표현하고 싶다. 왜냐면 y 범주가 200개면 분류모델이 형편없을 것이기 때문이다.

LDA로 클러스터를 하려면 우선 무엇을 해야할까?

```{r}
df['만족방문지'] %>% 
  group_by(만족방문지) %>%
  summarize(freq=n()) %>%
  top_n(10) %>%
  arrange(desc(freq))
```

경복궁 같은 경우도 종로/청계로 묶은 듯 하다. 이는 어느정도 수작업이 필요해 보이고 issue 하나다.


# 2 방문한 월

과연 월별로 추천을 다르게 해야할까?

## 2.1 월별 만족도
```{r}
df %>% 
  group_by(방문월, 만족도) %>%
  summarise(freq = n()) %>%
  group_by(방문월) %>%
  mutate(ratio = freq/sum(freq)) %>%
  arrange(방문월) %>%
  ggplot(aes(x=만족도, y=ratio, fill=방문월)) +
  geom_bar(stat='identity', position = 'dodge')
```

월은 딱히 유의한 차이는없다.

근데 이광춘 교수님꼐서 눈 대중말고 통계방법으로 재는 것 무엇이였더라...?

찾아낸 인사이트는 매우만족이냐 매우만족이 아니냐로 이분법으로 나누면 될 것 같다.

1. 분류에서 한쪽에 쏠린 샘플은 분류할 때 metric을 신경써야한다.
2. 대부분 만족하는 상황에서 우리의 추천이 의미가 있으려면 매우만족으로 보내드려야한다.

## 2.1.2 월별 방문지 트렌드

트렌드가 있다면 월마다 추천을 다르게 해줘야한다.

다를 것 같긴한데 아직 확신은 없다.

```{r}
location_list<- df %>% 
  group_by(만족방문지) %>%
  summarise(freq=n()) %>%
  arrange(desc(freq)) %>%
  pull(만족방문지)

loc <- list()

for(i in 1:22){
  start_index <- 1+(i-1)*10
  end_index<- (i)*10
  loc[[i]] <- as.vector(location_list[start_index:end_index])
}

```


```{r}
df %>% 
  group_by(방문월, 만족방문지) %>%
  summarise(freq = n()) %>%
  group_by(방문월) %>%
  mutate(ratio = freq/sum(freq)) %>%
  filter(만족방문지 %in% loc[[1]] ) %>%
  ggplot(aes(x=방문월, y=ratio, color=만족방문지)) +
  geom_point() +
  geom_line(aes(group = 만족방문지))
```

```{r}
df %>% 
  group_by(방문월, 만족방문지) %>%
  summarise(freq = n()) %>%
  group_by(방문월) %>%
  mutate(ratio = freq/sum(freq)) %>%
  filter(만족방문지 %in% loc[[2]] ) %>%
  ggplot(aes(x=방문월, y=ratio, color=만족방문지)) +
  geom_point() +
  geom_line(aes(group = 만족방문지))
```

```{r}
df %>% 
  group_by(방문월, 만족방문지) %>%
  summarise(freq = n()) %>%
  group_by(방문월) %>%
  mutate(ratio = freq/sum(freq)) %>%
  filter(만족방문지 %in% loc[[3]] ) %>%
  ggplot(aes(x=방문월, y=ratio, color=만족방문지)) +
  geom_point() +
  geom_line(aes(group = 만족방문지))
```

```{r}
df %>% 
  group_by(방문월, 만족방문지) %>%
  summarise(freq = n()) %>%
  group_by(방문월) %>%
  mutate(ratio = freq/sum(freq)) %>%
  filter(만족방문지 %in% loc[[4]] ) %>%
  ggplot(aes(x=방문월, y=ratio, color=만족방문지)) +
  geom_point() +
  geom_line(aes(group = 만족방문지))
```

확실히 계절 트렌드가 있는 것은 특수한 방문지 인 것 같다.

통계를 검정법을 이용해 유의한 것만 뽑아보자.(계절분해법,... 구글링해도 잘 안나옴옴)